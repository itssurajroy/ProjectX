
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ╔══════════════════════════════════════════════════════════╗
    // ║                     PUBLIC READS                         ║
    // ║  Anyone (even unauthenticated) can read basic data       ║
    // ╚══════════════════════════════════════════════════════════╝
    match /announcements/{doc} {
      allow read: if true;
    }
    match /settings/{doc} {
      allow read: if true;
    }
    match /overrides/{animeId} {
      allow read: if true;
    }
    match /skiptimes/{episodeId} {
      allow read: if true;
    }
    
    // Comments: Publicly readable, but writing is restricted.
    match /comments/{animeId}/episodes/{episodeId}/messages/{messageId} {
      allow read: if true;
      allow create: if false; // Change to `if request.auth != null;` when auth is re-enabled
      allow update, delete: if false;
    }

    // ╔══════════════════════════════════════════════════════════╗
    // ║                  POLLS + VOTES (WILDCARD FIX)            ║
    // ╚══════════════════════════════════════════════════════════╝
    // This matches ANY poll ID, even with slashes, underscores, dashes
    match /polls/{pollId=**}/votes/{voteId} {
      allow read: if true;  // Anyone can see who voted
      allow create, update, delete: if request.auth != null && request.auth.uid == voteId;
    }

    match /polls/{pollId=**} {
      allow read: if true;
      allow create, update: if request.auth != null;
    }

    // ╔══════════════════════════════════════════════════════════╗
    // ║                     USER DATA                            ║
    // ╚══════════════════════════════════════════════════════════╝
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ╔══════════════════════════════════════════════════════════╗
    // ║                        ADMIN                             ║
    // ╚══════════════════════════════════════════════════════════╝
    match /admin/{document=**} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ╔══════════════════════════════════════════════════════════╗
    // ║                     DENY ALL ELSE                        ║
    // ╚══════════════════════════════════════════════════════════╝
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
